{% extends "base.html" %}

{% block title %}Interview Copilot{% endblock %}

{% block content %}
<div class="landing-container" x-data="landingApp()">
    <!-- Main Content - Claude Style -->
    <main class="chatgpt-main">
        <!-- Claude-style greeting -->
        <div class="claude-greeting">
            <svg class="claude-icon" width="32" height="32" viewBox="0 0 24 24" fill="none">
                <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="currentColor"/>
            </svg>
            <h1 class="claude-title">Ready for your call?</h1>
        </div>

        <!-- Two-column: Persona + Knowledge Base -->
        <div class="landing-cards">
            <!-- Persona Card -->
            <div class="persona-card">
                <div class="persona-header">
                    <div class="persona-avatar">S</div>
                    <div class="persona-info">
                        <h2 class="persona-name">Sigrid</h2>
                        <p class="persona-role">Anthropic Developer Relations</p>
                    </div>
                </div>
                <div class="persona-details">
                    <p><strong>Role:</strong> Developer Relations IC</p>
                    <p><strong>Mission:</strong> Help developers build better with Claude</p>
                </div>
            </div>

            <!-- Knowledge Base Card -->
            <a href="/skills" class="knowledge-card">
                <div class="knowledge-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
                    </svg>
                    <span class="knowledge-title">Knowledge Base</span>
                    <svg class="knowledge-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </div>
                <div class="knowledge-stats">
                    <span class="stat-item">
                        <span class="stat-icon">üìò</span>
                        <span>5 Skills</span>
                    </span>
                    <span class="stat-divider">¬∑</span>
                    <span class="stat-item git-sync">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="4"/>
                            <line x1="1.05" y1="12" x2="7" y2="12"/>
                            <line x1="17.01" y1="12" x2="22.96" y2="12"/>
                        </svg>
                        <span>Git synced</span>
                    </span>
                </div>
            </a>
        </div>

        <!-- Today's Calls from Calendar -->
        <div class="calendar-section">
            <div class="calendar-header">
                <!-- Google Calendar Logo -->
                <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#4285F4" d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12s4.48 10 10 10 10-4.48 10-10z" opacity="0"/>
                    <path fill="#4285F4" d="M18 4H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                    <path fill="#FFFFFF" d="M18 5H6a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1z"/>
                    <path fill="#EA4335" d="M6 4h12v3H6z"/>
                    <path fill="#4285F4" d="M8 9h2v2H8zm0 3h2v2H8zm0 3h2v2H8zm3-6h2v2h-2zm0 3h2v2h-2zm0 3h2v2h-2zm3-6h2v2h-2zm0 3h2v2h-2z"/>
                    <path fill="#FBBC04" d="M17 4h1a2 2 0 0 1 2 2v1h-3V4z"/>
                    <path fill="#34A853" d="M4 7h3v3H4z" opacity="0"/>
                    <circle fill="#EA4335" cx="8" cy="4" r="1"/>
                    <circle fill="#EA4335" cx="16" cy="4" r="1"/>
                </svg>
                <span>Today's Calls</span>
                <span class="calendar-source">from Google Calendar</span>
            </div>
            <div class="calendar-events">
                <template x-for="event in calendarEvents" :key="event.id">
                    <div class="calendar-event" @click="selectEvent(event)" :class="{ 'selected': selectedEventId === event.id }">
                        <div class="event-time" x-text="event.time"></div>
                        <div class="event-details">
                            <div class="event-title" x-text="event.company"></div>
                            <div class="event-attendee">
                                <span x-text="event.attendee"></span>
                                <span class="event-role" x-text="'¬∑ ' + event.role"></span>
                            </div>
                            <div class="event-tags">
                                <template x-for="tag in event.tags" :key="tag">
                                    <span class="event-tag" x-text="tag"></span>
                                </template>
                            </div>
                        </div>
                        <div class="event-action">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Divider -->
        <div class="section-divider">
            <span>or describe your call</span>
        </div>

        <!-- Input Area -->
        <div class="chatgpt-input-container">
            <form @submit.prevent="startSession" class="chatgpt-form">
                <textarea
                    x-model="context"
                    @keydown.enter.ctrl="startSession"
                    @keydown.enter.meta="startSession"
                    placeholder="Call with FinBot (fintech startup). Head of Engineering, Sarah Chen. They've been using Claude API for 6 months, having issues with long conversations and token costs."
                    class="chatgpt-input"
                    rows="1"
                    x-ref="input"
                    @input="autoResize"
                ></textarea>

                <div class="chatgpt-input-footer">
                    <!-- Spacer -->
                    <div></div>

                    <!-- Submit button -->
                    <button
                        type="submit"
                        class="chatgpt-submit"
                        :disabled="!context.trim() || loading"
                        :class="{ 'active': context.trim() && !loading }"
                    >
                        <span x-show="loading" class="loading-spinner dark"></span>
                        <svg x-show="!loading" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14v-4H7l5-6v4h4l-5 6z" transform="rotate(90, 12, 12)"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>

        <!-- Quick action buttons - Claude style -->
        <div class="quick-actions">
            <button class="quick-action-btn" @click="fillTemplate('technical')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 18l2-2v-3"/>
                    <path d="M8 18l-2-2v-3"/>
                    <rect x="2" y="4" width="20" height="8" rx="2"/>
                </svg>
                Technical
            </button>
            <button class="quick-action-btn" @click="fillTemplate('pricing')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                Pricing
            </button>
            <button class="quick-action-btn" @click="fillTemplate('security')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Security
            </button>
            <button class="quick-action-btn" @click="fillTemplate('roadmap')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                </svg>
                Roadmap
            </button>
        </div>

        <!-- Subtle hint -->
        <p class="chatgpt-hint">Press <kbd>Ctrl</kbd>+<kbd>Enter</kbd> to start session</p>
    </main>

    <!-- Result Modal -->
    <div class="modal-overlay" x-show="showResult" x-cloak @click.self="showResult = false">
        <div class="modal-content" x-show="showResult" x-transition>
            <div class="modal-header">
                <h2>Session Ready</h2>
                <button @click="showResult = false" class="modal-close">&times;</button>
            </div>

            <div class="modal-body" x-show="prepResult">
                <!-- Brief -->
                <div class="result-section">
                    <h3>Brief</h3>
                    <p x-text="prepResult?.session_brief"></p>
                </div>

                <!-- Likely Topics -->
                <div class="result-section">
                    <h3>Likely Topics</h3>
                    <div class="topic-tags">
                        <template x-for="topic in prepResult?.likely_topics || []" :key="topic.topic">
                            <div class="topic-tag">
                                <span class="topic-name" x-text="topic.topic"></span>
                                <span class="topic-confidence" x-text="topic.confidence ? `${Math.round(topic.confidence * 100)}%` : ''"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Skills - Attached -->
                <div class="result-section">
                    <h3>üì¶ ATTACHED <span class="section-subtitle">(by Prep Agent ‚Äî baseline from customer brief)</span></h3>
                    <div class="skill-status-list">
                        <template x-for="(skill, index) in (prepResult?.recommended_skills || []).slice(0, 2)" :key="'attached-' + skill">
                            <div class="skill-status-item attached">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                                <span x-text="skill.replace(/_/g, ' ')"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Skills - Available -->
                <div class="result-section">
                    <h3>üì¶ AVAILABLE <span class="section-subtitle">(Router attaches dynamically)</span></h3>
                    <div class="skill-status-list">
                        <template x-for="skill in (prepResult?.recommended_skills || []).slice(2)" :key="'ready-' + skill">
                            <div class="skill-status-item available">
                                <span class="skill-circle"></span>
                                <span x-text="skill.replace(/_/g, ' ')"></span>
                            </div>
                        </template>
                        <!-- Always show memory_playbook, pricing_guidance, interview_records as available -->
                        <template x-if="!(prepResult?.recommended_skills || []).includes('cdp_memory')">
                            <div class="skill-status-item available">
                                <span class="skill-circle"></span>
                                <span>memory_playbook</span>
                                <span class="skill-hint">‚Üê Our guide for implementing Memory</span>
                            </div>
                        </template>
                    </div>
                    <p class="skills-note">These are CUSTOM skills our team created. You'd package your own org's knowledge.</p>
                </div>

                <!-- Discovery Questions (collapsible) -->
                <details class="result-section collapsible">
                    <summary>Discovery Questions</summary>
                    <ol class="question-list">
                        <template x-for="(q, i) in prepResult?.discovery_questions || []" :key="i">
                            <li x-text="q"></li>
                        </template>
                    </ol>
                </details>
            </div>

            <div class="modal-footer">
                <button @click="showResult = false" class="btn-secondary">Back</button>
                <button @click="enterSession" class="btn-primary" :disabled="entering">
                    <span x-show="!entering">Enter Session</span>
                    <span x-show="entering" class="loading-spinner"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="error-toast" x-show="error" x-cloak x-text="error" x-transition></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function landingApp() {
    return {
        context: '',
        prepResult: null,
        showResult: false,
        loading: false,
        entering: false,
        error: null,
        selectedEventId: null,

        // Mock calendar events (Google Calendar integration)
        calendarEvents: [
            {
                id: 1,
                time: '2:00 PM',
                company: 'FinBot',
                attendee: 'Sarah Chen',
                role: 'Head of Engineering',
                tags: ['Technical Discovery', 'Existing Customer'],
                context: `Call with FinBot (Series B fintech startup). Sarah Chen, Head of Engineering. Ex-Stripe, 8 years building payment systems.

They've been using Claude API for 6 months for their AI-powered financial advisor chatbot (50K+ retail investors).

Pain points flagged:
- Long conversations (20-50 turns) causing token costs to explode
- Context window filling up, Claude "forgets" earlier messages
- Tried naive truncation but users complain AI doesn't remember
- Compliance concern: can't lose user preferences like "no oil stocks"

Looking for: Better way to manage long conversations while keeping costs reasonable.`
            },
            {
                id: 2,
                time: '4:30 PM',
                company: 'MedAssist AI',
                attendee: 'Dr. James Park',
                role: 'CTO',
                tags: ['Initial Call', 'Healthcare'],
                context: `Initial discovery call with MedAssist AI (seed-stage health tech). Dr. James Park, CTO and co-founder.

Building an AI assistant for clinical documentation - helping doctors write notes faster.

Key concerns likely:
- HIPAA compliance
- Accuracy requirements (medical terminology)
- Integration with existing EHR systems
- On-premise deployment options`
            }
        ],

        selectEvent(event) {
            this.selectedEventId = event.id;
            this.context = event.context;
            // Auto-resize textarea
            this.$nextTick(() => {
                this.autoResize();
                // Auto-start session prep
                this.startSession();
            });
        },

        fillTemplate(type) {
            const templates = {
                technical: 'Call about technical architecture and API integration. The customer wants to discuss system design, data flow, and best practices for building with Claude.',
                pricing: 'Call to discuss pricing plans, costs, and enterprise options. Customer is evaluating Claude for their team and needs to understand the pricing model.',
                security: 'Security and compliance review call. Customer needs to understand SOC2 compliance, data handling, encryption, and enterprise security features.',
                roadmap: 'Product roadmap discussion. Customer wants to know about upcoming features, timelines, and planned improvements to the Claude API.'
            };
            this.context = templates[type] || '';
            this.$nextTick(() => {
                this.autoResize();
                this.$refs.input.focus();
            });
        },

        autoResize() {
            const el = this.$refs.input;
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        },

        async startSession() {
            if (!this.context.trim()) return;

            this.loading = true;
            this.error = null;

            try {
                // Send raw context - let Claude do the inference
                const response = await fetch('/api/prep', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_context: this.context
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to prepare session');
                }

                this.prepResult = await response.json();
                this.showResult = true;
            } catch (e) {
                this.error = e.message;
                setTimeout(() => this.error = null, 5000);
            } finally {
                this.loading = false;
            }
        },

        async enterSession() {
            this.entering = true;

            try {
                const response = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_context: this.context,
                        prep_result: this.prepResult
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create session');
                }

                const data = await response.json();
                window.location.href = `/session/${data.session_id}`;
            } catch (e) {
                this.error = e.message;
                setTimeout(() => this.error = null, 5000);
            } finally {
                this.entering = false;
            }
        }
    };
}
</script>
{% endblock %}
